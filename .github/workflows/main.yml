name: Java CI

on:
  push:
    branches:
      - main

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up JDK 17
      uses: actions/setup-java@v2
      with:
        distribution: 'adopt'
        java-version: '17'

    - name: Run tests and generate coverage
      run: |
        echo "Running Maven tests..."
        mvn test
        echo "Maven tests completed."

        echo "Formatting JaCoCo coverage..."
        ./cc-test-reporter format-coverage -t jacoco -o codeclimate.json -p target/site/jacoco/jacoco.xml
        echo "JaCoCo coverage formatted."

        echo "Files in the jacoco directory:"
        ls -R target/site/jacoco/

    - name: Upload coverage to Code Climate
      run: ./cc-test-reporter upload-coverage
      env:
        CC_TEST_REPORTER_ID: ${{ secrets.CODE_CLIMATE_REPORTER_ID }}
